<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedGame - Simulation Médicale</title>

    <!-- Fonts Modernes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap"
        rel="stylesheet">

    <!-- Icons & Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/device-check.css">

    <!-- Three.js pour la 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body>

    <!-- Canvas pour l'arrière-plan 3D (ADN) -->
    <div id="canvas-container"></div>

    <audio id="background-music" src="assets/sounds/hospital_ambient.mp3" loop></audio>

    <div class="scene-overlay">
        <div class="glass-card" id="main-card">
            <div class="header-content">
                <div class="icon-pulse">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h1 class="glitch-title" data-text="MEDGAME">MEDGAME</h1>
                <p class="subtitle">Simulation Clinique à Bichat
            </div>

            <div class="button-container">
                <button class="btn-3d primary" id="play-button" onclick="transitionTo('themes.html')">
                    <span class="btn-content"><i class="fas fa-play"></i> Lancer la garde</span>
                    <div class="btn-layer"></div>
                </button>

                <button class="btn-3d secondary" id="tutorial-button" onclick="transitionTo('tutorial.html')">
                    <span class="btn-content"><i class="fas fa-book-medical"></i> Tutoriel</span>
                    <div class="btn-layer"></div>
                </button>

                <button class="btn-3d tertiary" id="settings-button">
                    <span class="btn-content"><i class="fas fa-sliders-h"></i> Paramètres</span>
                    <div class="btn-layer"></div>
                </button>
            </div>

            <p class="disclaimer">Simulation à but éducatif uniquement (logique)</p>
        </div>
    </div>

    <!-- Modale Paramètres Refaite -->
    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-glass">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Configuration</h2>
                <button class="close-icon" id="settings-close-icon"><i class="fas fa-times"></i></button>
            </div>

            <div class="modal-body">
                <p class="setting-label">Difficulté (Temps imparti)</p>
                <div class="difficulty-selector">
                    <label class="diff-option">
                        <input type="radio" name="timeMode" value="facile">
                        <span class="diff-card green">
                            <i class="fas fa-user-md"></i>
                            <span>Interne</span>
                            <small>8 min</small>
                        </span>
                    </label>
                    <label class="diff-option">
                        <input type="radio" name="timeMode" value="normal">
                        <span class="diff-card blue">
                            <i class="fas fa-user-nurse"></i>
                            <span>Senior</span>
                            <small>4 min</small>
                        </span>
                    </label>
                    <label class="diff-option">
                        <input type="radio" name="timeMode" value="dur">
                        <span class="diff-card red">
                            <i class="fas fa-hospital-user"></i>
                            <span>Urgence</span>
                            <small>2m 30s</small>
                        </span>
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button id="settings-save" class="btn-flat save">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Script Logiciel & Animation -->
    <script>
        /* --- LOGIQUE 3D BACKGROUND (ADN) --- */
        const init3D = () => {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            // Ajout d'un brouillard pour la profondeur
            scene.fog = new THREE.FogExp2(0x000510, 0.002);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });

            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Création des particules ADN
            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCount = 700;
            const posArray = new Float32Array(particlesCount * 3);
            const colorArray = new Float32Array(particlesCount * 3);

            for (let i = 0; i < particlesCount; i++) {
                // Double helice logic
                const i3 = i * 3;
                const angle = i * 0.1;
                const radius = 3;
                const rise = i * 0.05 - 15; // Hauteur

                // Strand 1
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                // Strand 2 (offset by PI)
                const x2 = Math.cos(angle + Math.PI) * radius;
                const z2 = Math.sin(angle + Math.PI) * radius;

                // On alterne entre les deux brins pour remplir le tableau
                if (i % 2 === 0) {
                    posArray[i3] = x + (Math.random() - 0.5) * 0.5;
                    posArray[i3 + 1] = rise;
                    posArray[i3 + 2] = z + (Math.random() - 0.5) * 0.5;
                    // Couleur Cyan/Bleu
                    colorArray[i3] = 0.1;
                    colorArray[i3 + 1] = 0.8;
                    colorArray[i3 + 2] = 1.0;
                } else {
                    posArray[i3] = x2 + (Math.random() - 0.5) * 0.5;
                    posArray[i3 + 1] = rise;
                    posArray[i3 + 2] = z2 + (Math.random() - 0.5) * 0.5;
                    // Couleur Violet/Rose
                    colorArray[i3] = 1.0;
                    colorArray[i3 + 1] = 0.2;
                    colorArray[i3 + 2] = 0.6;
                }
            }

            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colorArray, 3));

            // Texture de particule (cercle soft)
            const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');

            const material = new THREE.PointsMaterial({
                size: 0.15,
                map: sprite,
                transparent: true,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            const particlesMesh = new THREE.Points(particlesGeometry, material);
            scene.add(particlesMesh);

            camera.position.z = 8;
            camera.position.y = -5;

            // Animation Loop
            const animate = () => {
                requestAnimationFrame(animate);
                particlesMesh.rotation.y += 0.003;
                particlesMesh.rotation.z += 0.001;

                // Effet de flottement caméra
                const time = Date.now() * 0.0005;
                camera.position.y += Math.sin(time) * 0.01;

                renderer.render(scene, camera);
            };
            animate();

            // Resize handler
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };

        init3D();

        /* --- LOGIQUE JEU & UI --- */

        // Gestion Paramètres
        if (!sessionStorage.getItem('timeLimitSeconds')) {
            sessionStorage.setItem('timeMode', 'normal');
            sessionStorage.setItem('timeLimitSeconds', '240');
        }

        const settingsBtn = document.getElementById('settings-button');
        const modal = document.getElementById('settings-modal');
        const closeBtn = document.getElementById('settings-close-icon');
        const saveBtn = document.getElementById('settings-save');

        const openModal = () => {
            modal.classList.add('active');
            const currentMode = sessionStorage.getItem('timeMode') || 'normal';
            const radio = document.querySelector(`input[name="timeMode"][value="${currentMode}"]`);
            if (radio) radio.checked = true;
        };

        const closeModal = () => modal.classList.remove('active');

        const saveSettings = () => {
            const checked = document.querySelector('input[name="timeMode"]:checked');
            if (checked) {
                const mode = checked.value;
                let sec = 240;
                if (mode === 'dur') sec = 150;
                if (mode === 'facile') sec = 480;

                sessionStorage.setItem('timeMode', mode);
                sessionStorage.setItem('timeLimitSeconds', String(sec));
                closeModal();
            }
        };

        settingsBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        saveBtn.addEventListener('click', saveSettings);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        // Gestion Musique (Améliorée)
        const audio = document.getElementById('background-music');
        audio.volume = 0.4; // Volume doux par défaut

        const startAudio = () => {
            const state = JSON.parse(sessionStorage.getItem('musicState'));
            if (state && state.isPlaying === false) return;

            if (!state || !state.time) audio.currentTime = 0;
            else audio.currentTime = state.time;

            audio.play().then(() => {
                sessionStorage.setItem('musicState', JSON.stringify({ isPlaying: true, time: audio.currentTime }));
            }).catch(() => console.log("Autoplay prevented"));
        };

        // Lance la musique au premier clic n'importe où
        document.body.addEventListener('click', startAudio, { once: true });

        window.addEventListener('beforeunload', () => {
            sessionStorage.setItem('musicState', JSON.stringify({ isPlaying: !audio.paused, time: audio.currentTime }));
        });

        window.addEventListener('load', () => {
            const state = JSON.parse(sessionStorage.getItem('musicState'));
            if (state && state.isPlaying) startAudio();
        });

        // Fonction transition douce
        function transitionTo(url) {
            document.body.style.opacity = 0;
            setTimeout(() => window.location.href = url, 500);
        }

        // Effet 3D Tilt sur la carte principale
        const card = document.getElementById('main-card');
        document.addEventListener('mousemove', (e) => {
            const xAxis = (window.innerWidth / 2 - e.pageX) / 25;
            const yAxis = (window.innerHeight / 2 - e.pageY) / 25;
            card.style.transform = `rotateY(${xAxis}deg) rotateX(${yAxis}deg)`;
        });
    </script>
    <script src="js/device-check.js"></script>
</body>

</html>